{% extends "base.html" %}

{% block title %}æ„è¦‹ä¸€è¦§{% endblock %}

{% block content %}
<div class="opinions-page">
    <h1>æ„è¦‹ä¸€è¦§</h1>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div class="filters">
        <form method="GET" action="{{ url_for('opinions') }}">
            <select name="category" onchange="this.form.submit()">
                <option value="">å…¨ã‚«ãƒ†ã‚´ãƒª</option>
                {% for cat in categories %}
                <option value="{{ cat }}" {% if cat==current_category %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
            </select>

            <select name="source" onchange="this.form.submit()">
                <option value="">å…¨ã‚½ãƒ¼ã‚¹</option>
                <option value="chat" {% if current_source=='chat' %}selected{% endif %}>ğŸ’¬ å¯¾è©±å‹</option>
                <option value="free_form" {% if current_source=='free_form' %}selected{% endif %}>ğŸ“ è‡ªç”±è¨˜è¿°</option>
                <option value="poll" {% if current_source=='poll' %}selected{% endif %}>ğŸ“Š é¸æŠå¼</option>
            </select>
        </form>
    </div>

    <!-- æ„è¦‹ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <table class="opinions-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>æ—¥æ™‚</th>
                <th>ã‚«ãƒ†ã‚´ãƒª</th>
                <th>å†…å®¹</th>
                <th>ã‚½ãƒ¼ã‚¹</th>
                <th>æ„Ÿæƒ…ã‚¹ã‚³ã‚¢</th>
                <th>å„ªå…ˆåº¦</th>
            </tr>
        </thead>
        <tbody>
            {% for op in opinions %}
            <tr>
                <td data-label="ID">{{ op.id }}</td>
                <td data-label="æ—¥æ™‚">{{ op.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td data-label="ã‚«ãƒ†ã‚´ãƒª"><span class="badge">{{ op.category or 'ãã®ä»–' }}</span></td>
                <td data-label="å†…å®¹" class="opinion-content">{{ op.content }}</td>
                <td data-label="ã‚½ãƒ¼ã‚¹">
                    {% if op.source_type == 'chat' %}ğŸ’¬ å¯¾è©±
                    {% elif op.source_type == 'free_form' %}ğŸ“ è¨˜è¿°
                    {% elif op.source_type == 'poll' %}ğŸ“Š æŠ•ç¥¨
                    {% endif %}
                </td>
                <td data-label="æ„Ÿæƒ…ã‚¹ã‚³ã‚¢">
                    <span class="emotion-score score-{{ (op.emotion_score // 3) if op.emotion_score else 0 }}">
                        {{ op.emotion_score if op.emotion_score else '-' }}
                    </span>
                </td>
                <td data-label="å„ªå…ˆåº¦">
                    {% if op.priority_score %}
                    {{ "%.2f"|format(op.priority_score) }}
                    {% else %}
                    -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="pagination">
        {% if page > 1 %}
        <a href="{{ url_for('opinions', page=page-1, category=current_category, source=current_source) }}">&laquo;
            å‰ã¸</a>
        {% endif %}

        <span>{{ page }} / {{ (total // per_page) + 1 }}</span>

        {% if page * per_page < total %} <a
            href="{{ url_for('opinions', page=page+1, category=current_category, source=current_source) }}">æ¬¡ã¸
            &raquo;</a>
            {% endif %}
    </div>
</div>
{% endblock %}
