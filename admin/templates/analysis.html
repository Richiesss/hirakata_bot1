{% extends "base.html" %}

{% block title %}AIåˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="header-actions">
        <h1>ğŸ¤– AIåˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <form action="{{ url_for('run_analysis') }}" method="post" style="display: inline;">
            <button type="submit" class="btn btn-primary" id="analyze-btn">
                <i class="fas fa-sync"></i> åˆ†æã‚’å®Ÿè¡Œ
            </button>
        </form>
    </div>

    {% if not results %}
    <div class="card">
        <div class="empty-state">
            <p>ã¾ã åˆ†æçµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œåˆ†æã‚’å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€æ„è¦‹ãƒ‡ãƒ¼ã‚¿ã®åˆ†æã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>
            <p class="text-muted">â€»åˆå›å®Ÿè¡Œæ™‚ã¯ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
        </div>
    </div>
    {% else %}

    <!-- åˆ†æã‚µãƒãƒªãƒ¼ -->
    <div class="summary-cards">
        <div class="card card-info">
            <h3>åˆ†æå¯¾è±¡</h3>
            <p class="big-number">{{ results.total }}</p>
            <p class="sub-text">ä»¶ã®æ„è¦‹</p>
        </div>
        <div class="card card-success">
            <h3>ã‚¯ãƒ©ã‚¹ã‚¿æ•°</h3>
            <p class="big-number">{{ results.clusters|length }}</p>
            <p class="sub-text">ã‚°ãƒ«ãƒ¼ãƒ—</p>
        </div>
    </div>

    <!-- æ•£å¸ƒå›³ -->
    <div class="card">
        <h2>æ„è¦‹ã®åˆ†å¸ƒ (ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°çµæœ)</h2>
        <div class="plot-container" style="text-align: center;">
            <img src="data:image/png;base64,{{ results.plot_image }}" alt="Clustering Plot"
                style="max-width: 100%; border-radius: 8px;">
        </div>
    </div>

    <!-- ã‚¯ãƒ©ã‚¹ã‚¿è©³ç´° -->
    <div class="card">
        <h2>ã‚¯ãƒ©ã‚¹ã‚¿è©³ç´°</h2>
        <div class="cluster-grid">
            {% for label, cluster in results.clusters.items() %}
            <div class="cluster-card">
                <div class="cluster-header">
                    <span class="cluster-badge cluster-{{ label }}">Group {{ label }}</span>
                    <span class="cluster-count">{{ cluster.count }}ä»¶</span>
                </div>
                <div class="cluster-body">
                    <h4>ä»£è¡¨çš„ãªæ„è¦‹:</h4>
                    <p class="representative-text">"{{ cluster.representative }}"</p>

                    <details>
                        <summary>å«ã¾ã‚Œã‚‹æ„è¦‹ (ä¸€éƒ¨)</summary>
                        <ul class="opinion-list">
                            {% for text in cluster.texts[:5] %}
                            <li>{{ text[:30] }}...</li>
                            {% endfor %}
                        </ul>
                    </details>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<style>
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
    }

    .cluster-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .cluster-card {
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 15px;
        background: #f9f9f9;
    }

    .cluster-header {
        display: flex;
        justify_content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .cluster-badge {
        padding: 4px 8px;
        border-radius: 4px;
        color: white;
        background-color: #666;
        font-weight: bold;
    }

    /* ç°¡æ˜“çš„ãªè‰²åˆ†ã‘ (K-Meansã®ãƒ©ãƒ™ãƒ«ã«åˆã‚ã›ã¦) */
    .cluster-0 {
        background-color: #440154;
    }

    .cluster-1 {
        background-color: #3b528b;
    }

    .cluster-2 {
        background-color: #21918c;
    }

    .cluster-3 {
        background-color: #5ec962;
    }

    .cluster-4 {
        background-color: #fde725;
        color: #333;
    }

    .representative-text {
        font-style: italic;
        color: #555;
        background: #fff;
        padding: 10px;
        border-radius: 4px;
        border-left: 3px solid #ccc;
    }

    .opinion-list {
        list-style: none;
        padding: 0;
        margin-top: 10px;
        font-size: 0.9em;
    }

    .opinion-list li {
        margin-bottom: 5px;
        padding-bottom: 5px;
        border-bottom: 1px dashed #eee;
    }
</style>

<script>
    document.getElementById('analyze-btn').addEventListener('click', function () {
        var btn = this;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆ†æã‚’å®Ÿè¡Œä¸­...';
        btn.disabled = true;

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        btn.form.submit();

        // é•·æ™‚é–“ã‹ã‹ã‚‹å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        setTimeout(function () {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­...';
        }, 3000);
    });
</script>
{% endblock %}