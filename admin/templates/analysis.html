{% extends "base.html" %}

{% block title %}AI分析ダッシュボード{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="header-actions">
        <h1>AI分析ダッシュボード</h1>
        <div class="action-buttons" style="display: flex; gap: 10px; align-items: center;">
            <form action="{{ url_for('run_analysis') }}" method="post"
                style="display: inline-flex; align-items: center; gap: 10px;">
                <select name="analysis_scope" class="form-control" style="width: auto;">
                    <option value="recent_200">最新200件 (デフォルト)</option>
                    <option value="recent_1000">最新1000件</option>
                    <option value="imported">インポートデータのみ</option>
                    <option value="all">全データ (時間がかかります)</option>
                </select>
                <input type="hidden" name="analysis_mode" value="classic">
                <button type="submit" class="btn btn-primary" id="analyze-btn">
                    <i class="fas fa-sync"></i> 分析を実行 (旧版)
                </button>
            </form>

            <form action="{{ url_for('run_analysis') }}" method="post"
                style="display: inline-flex; align-items: center; gap: 10px;">
                <select name="analysis_scope" class="form-control" style="width: auto;">
                    <option value="recent_200">最新200件 (デフォルト)</option>
                    <option value="recent_1000">最新1000件</option>
                    <option value="imported">インポートデータのみ</option>
                    <option value="all">全データ (時間がかかります)</option>
                </select>
                <input type="hidden" name="analysis_mode" value="smart">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-brain"></i> スマート分析 (新版)
                </button>
            </form>

            {% if results %}
            <a href="{{ url_for('export_pdf') }}" class="btn btn-secondary" target="_blank">
                <i class="fas fa-file-pdf"></i> PDFレポート出力
            </a>
            {% endif %}
        </div>
    </div>

    {% if not results %}
    <div class="card">
        <div class="empty-state">
            <p>まだ分析結果がありません。「分析を実行」ボタンを押して、意見データの分析を開始してください。</p>
            <p class="text-muted">※初回実行時はモデルの読み込みに時間がかかる場合があります。</p>
        </div>
    </div>
    {% else %}

    <!-- 分析サマリー -->
    <div class="summary-cards">
        <div class="card card-info">
            <h3>分析対象</h3>
            <p class="big-number">{{ results.total }}</p>
            <p class="sub-text">件の意見</p>
        </div>
        <div class="card card-success">
            <h3>クラスタ数</h3>
            <p class="big-number">{{ results.clusters|length }}</p>
            <p class="sub-text">グループ</p>
        </div>
    </div>

    <!-- 散布図 -->
    <div class="card">
        <h2>意見の分布 (クラスタリング結果)</h2>
        <div class="plot-container" style="text-align: center;">
            <img src="{{ url_for('static', filename='tmp/' + results.plot_image_file) }}" alt="Clustering Plot"
                style="max-width: 100%; border-radius: 8px;">
        </div>
    </div>

    <!-- クラスタ詳細 -->
    <div class="card">
        <h2>クラスタ詳細</h2>
        <div class="cluster-grid">
            {% for label, cluster in results.clusters.items() %}
            <div class="cluster-card">
                <div class="cluster-header">
                    <span class="cluster-badge cluster-{{ label }}">Group {{ label }}</span>
                    <span class="cluster-count">{{ cluster.count }}件</span>
                </div>
                <div class="cluster-body">
                    <h4>代表的な意見:</h4>
                    <p class="representative-text">"{{ cluster.representative }}"</p>

                    <details>
                        <summary>含まれる意見 (一部)</summary>
                        <ul class="opinion-list">
                            {% for text in cluster.texts[:5] %}
                            <li>{{ text[:30] }}...</li>
                            {% endfor %}
                        </ul>
                    </details>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<style>
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
    }

    .cluster-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .cluster-card {
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 15px;
        background: #f9f9f9;
    }

    .cluster-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .cluster-badge {
        padding: 4px 8px;
        border-radius: 4px;
        color: white;
        background-color: #666;
        font-weight: bold;
    }

    /* 簡易的な色分け (K-Meansのラベルに合わせて) */
    .cluster-0 {
        background-color: #440154;
    }

    .cluster-1 {
        background-color: #3b528b;
    }

    .cluster-2 {
        background-color: #21918c;
    }

    .cluster-3 {
        background-color: #5ec962;
    }

    .cluster-4 {
        background-color: #fde725;
        color: #333;
    }

    .representative-text {
        font-style: italic;
        color: #555;
        background: #fff;
        padding: 10px;
        border-radius: 4px;
        border-left: 3px solid #ccc;
    }

    .opinion-list {
        list-style: none;
        padding: 0;
        margin-top: 10px;
        font-size: 0.9em;
    }

    .opinion-list li {
        margin-bottom: 5px;
        padding-bottom: 5px;
        border-bottom: 1px dashed #eee;
    }
</style>

<script>
    document.getElementById('analyze-btn').addEventListener('click', function () {
        var btn = this;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 分析を実行中...';
        btn.disabled = true;

        // フォーム送信
        btn.form.submit();

        // 長時間かかる場合のメッセージ表示（オプション）
        setTimeout(function () {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> モデル読み込み中...';
        }, 3000);
    });
</script>
{% endblock %}
