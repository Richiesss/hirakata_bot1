# 同時実行制御ガイド

## 概要

AI分析機能に**同時実行制御（ロック機能）**を実装しました。これにより、複数のユーザーが同時に分析を実行しようとした場合でも、安全に処理できます。

## 実装内容

### 1. **ファイルベースのロック機構**

`/tmp/hirakata_analysis_locks/analysis.lock` を使用して、分析処理の排他制御を実現。

### 2. **主な機能**

#### ✅ 同時実行の防止
- 1度に1つの分析プロセスのみが実行可能
- 2人目以降はユーザーフレンドリーなメッセージで通知

#### ✅ 自動クリーンアップ
- 10分以上経過した古いロックは自動削除
- プロセスがクラッシュしてもロックが残らない

#### ✅ タイムアウト制御
- ロック取得待機は最大10秒
- タイムアウト後は適切なエラーメッセージを表示

---

## 動作イメージ

### ケース1: 正常な単独実行

```
[ユーザーA] スマート分析を実行
    ↓
[システム] ロック取得 ✓
    ↓
[システム] 分析実行中...（30秒）
    ↓
[システム] ロック解放
    ↓
[ユーザーA] 結果表示
```

### ケース2: 同時実行の衝突

```
[ユーザーA] スマート分析を実行（実行時間: 30秒）
    ↓
[システム] ロック取得 ✓
    ↓
    [ユーザーB] スマート分析を実行（同時）
         ↓
    [システム] ロックチェック → 既に実行中
         ↓
    [ユーザーB] 警告メッセージ表示:
                「現在、他のユーザーが分析を実行中です（実行時間: 5秒）。
                 しばらく待ってから再試行してください。」
         ↓
    [ユーザーB] 分析画面にリダイレクト（実行されない）

[ユーザーA] 分析完了 → ロック解放
```

### ケース3: 古いロックの自動削除

```
[システム] 10分前のロックファイルを検出
    ↓
[システム] 自動クリーンアップ実行
    ↓
[ユーザー] 通常通り分析実行可能
```

---

## 技術詳細

### ロックファイルの構造

```
/tmp/hirakata_analysis_locks/analysis.lock
```

**ファイル内容:**
```
12345                          # プロセスID
2025-12-09T21:30:00.123456     # ロック取得時刻（ISO形式）
```

### コード実装

#### 1. ロック管理クラス

[utils/analysis_lock.py](../utils/analysis_lock.py)

```python
class AnalysisLock:
    def acquire(self, timeout: int = 5) -> bool:
        """ロック取得（最大5秒待機）"""

    def release(self):
        """ロック解放"""

    def is_locked(self) -> bool:
        """ロック状態確認"""

    def _cleanup_stale_lock(self):
        """古いロック（10分以上）を自動削除"""
```

#### 2. 管理画面での使用

[admin/admin_app.py:386-395](../admin/admin_app.py#L386-L395)

```python
# 同時実行チェック
lock = get_analysis_lock()
if lock.is_locked():
    lock_info = lock.get_lock_info()
    if lock_info:
        age = int(lock_info['age_seconds'])
        flash(f'現在、他のユーザーが分析を実行中です（実行時間: {age}秒）。
              しばらく待ってから再試行してください。', 'warning')
    return redirect(url_for('analysis'))

# ロックを取得して処理
with lock:
    # 分析実行...
```

---

## パフォーマンス

### 処理時間の目安

| データ量 | 処理時間 | 同時実行制限時間 |
|---------|---------|-----------------|
| 最新200件 | 20-40秒 | この間は他ユーザー待機 |
| 最新1000件 | 1-2分 | この間は他ユーザー待機 |
| 全データ（3000件+） | 2-5分 | この間は他ユーザー待機 |

### ロックタイムアウト設定

- **取得待機**: 最大10秒
- **自動解放**: 10分で強制削除

---

## テスト方法

### 1. 単体テスト

```bash
cd /home/hirakata_bot1
python test_concurrent_analysis.py
```

**期待結果:**
```
[Worker 1] ✓ ロック取得成功！
[Worker 2] ❌ ロック取得失敗（タイムアウト）
[Worker 3] ❌ ロック取得失敗（タイムアウト）
```

### 2. 実環境テスト

**手順:**
1. ブラウザAで分析を実行
2. すぐにブラウザBで分析を実行
3. ブラウザBに警告メッセージが表示されることを確認

---

## トラブルシューティング

### Q1: ロックが解放されない

**症状:**
```
現在、他のユーザーが分析を実行中です（実行時間: 650秒）。
```

**原因:**
- プロセスがクラッシュしてロックが残っている
- 10分を超えているが自動削除されていない

**解決方法:**
```bash
# 手動でロックファイルを削除
rm -f /tmp/hirakata_analysis_locks/analysis.lock

# または再起動
./clear_sessions_and_restart.sh
```

### Q2: 複数ユーザーが同時に実行できてしまう

**原因:**
- ロック機構が無効化されている
- ファイルシステムの権限問題

**確認方法:**
```bash
# ロックディレクトリの存在確認
ls -la /tmp/hirakata_analysis_locks/

# 権限確認（書き込み可能か）
touch /tmp/hirakata_analysis_locks/test.txt
```

### Q3: 分析が開始されない

**症状:**
- 「スマート分析を実行」を押しても何も起きない

**原因:**
- 古いロックが残っている

**解決方法:**
```bash
# ロック状態確認
cat /tmp/hirakata_analysis_locks/analysis.lock

# 古ければ削除
rm -f /tmp/hirakata_analysis_locks/analysis.lock
```

---

## 設定変更

### ロックタイムアウトの変更

`utils/analysis_lock.py` の定数を変更:

```python
# 10分 → 20分に延長
MAX_LOCK_AGE_SECONDS = 1200  # 変更前: 600
```

### 取得待機時間の変更

`admin/admin_app.py` の `acquire()` 呼び出しを変更:

```python
# 10秒 → 30秒に延長
with lock:  # デフォルト10秒
    # ...

# または明示的に指定
if not lock.acquire(timeout=30):
    # エラー処理
```

---

## セキュリティ考慮事項

### 1. **DoS攻撃の防止**

- ロックは最大10分で自動解放
- 悪意のあるユーザーが長時間占有することを防止

### 2. **ファイルパーミッション**

- `/tmp` ディレクトリ使用（自動クリーンアップ）
- プロセス間で共有可能

### 3. **PID検証**

- ロック解放時に自分のPIDか確認
- 他プロセスのロックを誤って解放しない

---

## 今後の改善案

### 短期
- ✅ ファイルベースロック（実装済み）
- [ ] ロック待機キュー（順番管理）
- [ ] リアルタイム進捗表示

### 中期
- [ ] Redisベースのロック（マルチサーバー対応）
- [ ] 分析タスクのバックグラウンド実行
- [ ] 結果のキャッシュ機能

### 長期
- [ ] 非同期タスクキュー（Celery）
- [ ] 分散処理対応
- [ ] 分析結果の履歴管理

---

## 関連ファイル

- [utils/analysis_lock.py](../utils/analysis_lock.py) - ロック実装
- [admin/admin_app.py](../admin/admin_app.py) - 管理画面統合
- [test_concurrent_analysis.py](../test_concurrent_analysis.py) - テスト
- [docs/ai_analysis_v2_guide.md](./ai_analysis_v2_guide.md) - AI分析ガイド

---

**作成日**: 2025年12月9日
**バージョン**: 1.0
**担当**: 同時実行制御チーム
