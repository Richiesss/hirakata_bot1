# ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰

## ğŸ”¥ Internal Server Errorå¯¾ç­–

### å•é¡Œ1: AIåˆ†æä¸­ã«Internal Server Error

#### ç—‡çŠ¶
- åˆ†æå®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨500ã‚¨ãƒ©ãƒ¼
- ãƒ–ãƒ©ã‚¦ã‚¶ã«ã€ŒInternal Server Errorã€ã¨è¡¨ç¤º
- ãƒ­ã‚°ã«ã€ŒAnalysis completedã€ãŒå‡ºãªã„

#### åŸå› 
**Gunicornã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ30ç§’ï¼‰ã‚’è¶…é**

AIåˆ†æã¯ä»¥ä¸‹ã®æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ï¼š
- æœ€æ–°200ä»¶: 20-40ç§’ âš ï¸
- æœ€æ–°1000ä»¶: 1-2åˆ† âŒ
- å…¨ãƒ‡ãƒ¼ã‚¿: 2-5åˆ† âŒ

#### è§£æ±ºæ–¹æ³•

**A. æ¨å¥¨: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å»¶é•·ã—ã¦èµ·å‹•**

```bash
cd /home/hirakata_bot1
./start_admin_with_timeout.sh
```

ã“ã®èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ï¼š
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: **300ç§’ï¼ˆ5åˆ†ï¼‰**
- ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 300ç§’
- ãƒ¯ãƒ¼ã‚«ãƒ¼æ•°: 2

**B. ãƒ‡ãƒ¼ã‚¿é‡ã‚’æ¸›ã‚‰ã™**

- ã€Œæœ€æ–°200ä»¶ã€ã§åˆ†æï¼ˆæ¨å¥¨ï¼‰
- ã€Œå…¨ãƒ‡ãƒ¼ã‚¿ã€ã¯é¿ã‘ã‚‹

---

### å•é¡Œ2: plot_image KeyError

#### ç—‡çŠ¶
```
KeyError: 'plot_image'
```

#### åŸå› 
æ—§ã‚³ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¦ã„ã‚‹

#### è§£æ±ºæ–¹æ³•
```bash
./clear_sessions_and_restart.sh
```

---

### å•é¡Œ3: åˆ†æãŒçµ‚ã‚ã‚‰ãªã„

#### ç—‡çŠ¶
- ãšã£ã¨ã€Œåˆ†æã‚’å®Ÿè¡Œä¸­...ã€ã®ã¾ã¾
- ãƒ­ã‚°ã«ã€ŒStarting AI analysisã€ã ã‘ã§ã€ŒAnalysis completedã€ãŒãªã„

#### åŸå› 
1. OllamaãŒãƒãƒ³ã‚°
2. LLMã®å‡¦ç†ãŒé…ã„
3. ãƒ­ãƒƒã‚¯ãŒå–å¾—ã§ããªã„

#### è§£æ±ºæ–¹æ³•

**A. Ollamaã®çŠ¶æ…‹ç¢ºèª**
```bash
curl http://localhost:11434/api/tags
```

å¿œç­”ãŒãªã„å ´åˆ:
```bash
# Ollamaã‚’å†èµ·å‹•
pkill ollama
ollama serve &
```

**B. ãƒ­ãƒƒã‚¯çŠ¶æ…‹ç¢ºèª**
```bash
cat /tmp/hirakata_analysis_locks/analysis.lock
```

å¤ã„ãƒ­ãƒƒã‚¯ãŒã‚ã‚‹å ´åˆ:
```bash
rm -f /tmp/hirakata_analysis_locks/analysis.lock
```

**C. ãƒ—ãƒ­ã‚»ã‚¹å†èµ·å‹•**
```bash
./start_admin_with_timeout.sh
```

---

### å•é¡Œ4: è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§åŒæ™‚å®Ÿè¡Œã§ããªã„

#### ç—‡çŠ¶
ã€Œç¾åœ¨ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆ†æã‚’å®Ÿè¡Œä¸­ã§ã™ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹

#### åŸå› 
**æ­£å¸¸å‹•ä½œã§ã™** - åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡ãŒæ©Ÿèƒ½ã—ã¦ã„ã¾ã™

#### è§£æ±ºæ–¹æ³•
- å…ˆè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‡¦ç†å®Œäº†ã‚’å¾…ã¤ï¼ˆé€šå¸¸20-40ç§’ï¼‰
- 10åˆ†çµŒã£ã¦ã‚‚çµ‚ã‚ã‚‰ãªã„å ´åˆã¯æ‰‹å‹•ã§ãƒ­ãƒƒã‚¯è§£é™¤:
  ```bash
  rm -f /tmp/hirakata_analysis_locks/analysis.lock
  ```

---

## ğŸ” ãƒ­ã‚°ç¢ºèªæ–¹æ³•

### ç®¡ç†ç”»é¢ãƒ­ã‚°
```bash
tail -50 /home/hirakata_bot1/logs/admin.log
```

### Gunicornã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
```bash
tail -50 /home/hirakata_bot1/logs/gunicorn_error.log
```

### Gunicornã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°
```bash
tail -50 /home/hirakata_bot1/logs/gunicorn_access.log
```

### ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼ç›£è¦–
```bash
tail -f /home/hirakata_bot1/logs/admin.log | grep ERROR
```

---

## ğŸ› ï¸ ã‚ˆãä½¿ã†ã‚³ãƒãƒ³ãƒ‰

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢ï¼†å†èµ·å‹•
```bash
./clear_sessions_and_restart.sh
```

### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå»¶é•·ã§èµ·å‹•
```bash
./start_admin_with_timeout.sh
```

### ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
```bash
ps aux | grep gunicorn
```

### ãƒ­ãƒƒã‚¯çŠ¶æ…‹ç¢ºèª
```bash
ls -la /tmp/hirakata_analysis_locks/
```

### OllamaçŠ¶æ…‹ç¢ºèª
```bash
curl http://localhost:11434/api/tags
```

---

## âš™ï¸ è¨­å®šå€¤

### ç¾åœ¨ã®è¨­å®š
- **Gunicornã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 300ç§’ï¼ˆ5åˆ†ï¼‰
- **ãƒ¯ãƒ¼ã‚«ãƒ¼æ•°**: 2
- **ãƒ­ãƒƒã‚¯æœ€å¤§ä¿æŒæ™‚é–“**: 10åˆ†
- **ãƒ­ãƒƒã‚¯å–å¾—å¾…æ©Ÿ**: 10ç§’

### å¤‰æ›´æ–¹æ³•

`start_admin_with_timeout.sh` ã‚’ç·¨é›†:

```bash
./venv/bin/gunicorn -w 2 -b 0.0.0.0:8080 \
    --timeout 300 \          # â† ã“ã“ã‚’å¤‰æ›´ï¼ˆç§’ï¼‰
    --graceful-timeout 300 \
    ...
```

---

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

### ãƒ‡ãƒ¼ã‚¿é‡ã¨å‡¦ç†æ™‚é–“

| ãƒ‡ãƒ¼ã‚¿é‡ | å‡¦ç†æ™‚é–“ | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š |
|---------|---------|-----------------|
| æœ€æ–°200ä»¶ | 20-40ç§’ | 60ç§’ä»¥ä¸Šæ¨å¥¨ |
| æœ€æ–°1000ä»¶ | 1-2åˆ† | 180ç§’ä»¥ä¸Šæ¨å¥¨ |
| å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆ3000ä»¶+ï¼‰ | 2-5åˆ† | 300ç§’ä»¥ä¸Šæ¨å¥¨ |

### æ¨å¥¨è¨­å®š
- é€šå¸¸åˆ©ç”¨: `--timeout 300`ï¼ˆ5åˆ†ï¼‰
- å¤§é‡ãƒ‡ãƒ¼ã‚¿: `--timeout 600`ï¼ˆ10åˆ†ï¼‰
- ãƒ†ã‚¹ãƒˆç’°å¢ƒ: `--timeout 60`ï¼ˆ1åˆ†ï¼‰

---

## ğŸš¨ ç·Šæ€¥å¯¾å¿œ

### ã‚µãƒ¼ãƒãƒ¼ãŒå¿œç­”ã—ãªã„
```bash
# 1. ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
ps aux | grep gunicorn

# 2. å¼·åˆ¶çµ‚äº†
pkill -9 -f gunicorn

# 3. å†èµ·å‹•
./start_admin_with_timeout.sh
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼
```bash
# PostgreSQLçŠ¶æ…‹ç¢ºèª
sudo systemctl status postgresql

# å†èµ·å‹•
sudo systemctl restart postgresql
```

### Ollamaå¿œç­”ãªã—
```bash
# ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
ps aux | grep ollama

# å†èµ·å‹•
pkill ollama
ollama serve &
```

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆæƒ…å ±

### å•é¡ŒãŒè§£æ±ºã—ãªã„å ´åˆ

1. **ãƒ­ã‚°ã‚’ç¢ºèª**
   ```bash
   tail -100 /home/hirakata_bot1/logs/admin.log
   tail -100 /home/hirakata_bot1/logs/gunicorn_error.log
   ```

2. **ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª**
   ```bash
   # ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡
   df -h

   # ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
   free -h

   # ãƒ—ãƒ­ã‚»ã‚¹ä¸€è¦§
   ps aux | grep -E "gunicorn|ollama|postgres"
   ```

3. **GitHub Issueã«å ±å‘Š**
   - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   - ãƒ­ã‚°ã®è©²å½“éƒ¨åˆ†
   - å®Ÿè¡Œç’°å¢ƒæƒ…å ±

---

## ğŸ”„ å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### æ¯é€±
```bash
# å¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
find /home/hirakata_bot1/logs -name "*.log" -mtime +30 -delete

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¯ãƒªã‚¢
rm -rf /home/hirakata_bot1/admin/flask_session/*

# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
rm -f /home/hirakata_bot1/admin/static/tmp/analysis_*.png
```

### æ¯æœˆ
```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒã‚­ãƒ¥ãƒ¼ãƒ 
sudo -u postgres psql hirakata_bot -c "VACUUM ANALYZE;"

# ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª
ls -lh /home/hirakata_bot1/logs/
```

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´12æœˆ9æ—¥
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.1
